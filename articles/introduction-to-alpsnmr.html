<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to AlpsNMR • AlpsNMR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to AlpsNMR">
<meta property="og:description" content="AlpsNMR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">AlpsNMR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction-to-alpsnmr.html">AlpsNMR Workflow
</a>
    </li>
    <li>
      <a href="../articles/tutorial_MTBLS242.html">AlpsNMR tutorial
</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sipss/AlpsNMR">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction-to-alpsnmr_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to AlpsNMR</h1>
                        <h4 class="author">Sergio Oller, Institute for Bioengineering of Catalonia</h4>
            
            <h4 class="date">2021-08-05</h4>
      
      
      <div class="hidden name"><code>introduction-to-alpsnmr.Rmd</code></div>

    </div>

    
    
<p>The <code>AlpsNMR</code> package was written with two purposes in mind:</p>
<ul>
<li>to help <strong>data analysts and NMR scientists</strong> to work with NMR samples.</li>
<li>to help <strong>IT pipeline builders</strong> implement automated methods for preprocessing.</li>
</ul>
<p>Functions from this package written for data analysts and NMR scientists are prefixed with <code>nmr_</code>, while higher level functions written for IT pipeline builders are prefixed with <code>pipe_</code>. The main reason why all exported functions have a prefix is to make it easy for the user to discover the functions from the package. By typing nmr_ RStudio will return the list of exported functions. In the R terminal, nmr_ followed by the tab key (⇥) twice will have the same effect. Other popular packages, follow similar approaches (e.g: <code>forcats</code>: <code>fct_*</code>, <code>stringr</code>: <code>str_*</code>).</p>
<p>This vignette is written for the first group. It assumes some prior basic knowledge of NMR and data analysis, as well as some basic R programming. In case you are interested in building pipelines with this package, you may want to open the file saved in this directory (run it on your computer):</p>
<pre><code>pipeline_example &lt;- system.file("pipeline-rmd", "pipeline_example.R", package = "AlpsNMR")
pipeline_example</code></pre>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AlpsNMR</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: dplyr</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="co">#&gt; Loading required package: future</span>
<span class="co">#&gt; Loading required package: magrittr</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<div id="enable-parallellization" class="section level1">
<h1 class="hasAnchor">
<a href="#enable-parallellization" class="anchor"></a>Enable parallellization</h1>
<p>This package is able to parallellize several functions through the use of the <code>future</code> and <code>furrr</code> packages. Whether to parallelize or not is left to the user that can control the parallellization by setting “plans”.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#plan(sequential()) # disable parallellization (default)</span>
<span class="fu">plan</span><span class="op">(</span><span class="fu">multiprocess</span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="co"># enable parallellization with 4 workers</span></code></pre></div>
</div>
<div id="data-the-meoh_plasma_extraction-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#data-the-meoh_plasma_extraction-dataset" class="anchor"></a>Data: The <code>MeOH_plasma_extraction</code> dataset</h1>
<p>To explore the basics of the AlpsNMR package, we have included four NMR samples acquired in a 600 MHz Bruker instrument bundled with the package. The samples are pooled quality control plasma samples, that were extracted with methanol, and therefore only contain small molecules.</p>
<p>If you have installed this package, you can obtain the directory where the four samples are with the command</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">MeOH_plasma_extraction_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"dataset-demo"</span>, package <span class="op">=</span> <span class="st">"AlpsNMR"</span><span class="op">)</span>
<span class="va">MeOH_plasma_extraction_dir</span>
<span class="co">#&gt; [1] "/__w/_temp/Library/AlpsNMR/dataset-demo"</span></code></pre></div>
<p>The demo directory includes four samples (zipped) and a dummy Excel metadata file.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="va">MeOH_plasma_extraction_dir</span><span class="op">)</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/10.zip</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/20.zip</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/30.zip</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/README.txt</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/dummy_metadata.xlsx</span></code></pre></div>
<p>Given the name of the dataset, one may guess that the dataset was used to check the Methanol extraction in serum samples. The dummy metadata consists of dummy information, just for the sake of showing how this package can integrate external metadata. The excel file consists of two tidy tables, in two sheets.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">MeOH_plasma_extraction_xlsx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">MeOH_plasma_extraction_dir</span>, <span class="st">"dummy_metadata.xlsx"</span><span class="op">)</span>
<span class="va">exp_subj_id</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="va">MeOH_plasma_extraction_xlsx</span>, sheet <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">subj_id_age</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="va">MeOH_plasma_extraction_xlsx</span>, sheet <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">exp_subj_id</span>
<span class="co">#&gt; # A tibble: 3 × 3</span>
<span class="co">#&gt;   NMRExperiment SubjectID TimePoint</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;chr&gt;     &lt;chr&gt;    </span>
<span class="co">#&gt; 1 10            Ana       baseline </span>
<span class="co">#&gt; 2 20            Ana       3 months </span>
<span class="co">#&gt; 3 30            Elia      baseline</span>
<span class="va">subj_id_age</span>
<span class="co">#&gt; # A tibble: 2 × 2</span>
<span class="co">#&gt;   SubjectID   Age</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Ana          29</span>
<span class="co">#&gt; 2 Elia          0</span></code></pre></div>
</div>
<div id="loading-samples" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-samples" class="anchor"></a>Loading samples</h1>
<p>The function to read samples is called <code>nmr_read_samples</code>. It expects a character vector with the samples to load that can be paths to directories of Bruker format samples or paths to JDX files.</p>
<p>Additionally, this function can filter by pulse sequences (e.g. load only NOESY samples) or loading only metadata.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">zip_files</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="va">MeOH_plasma_extraction_dir</span>, glob <span class="op">=</span> <span class="st">"*.zip"</span><span class="op">)</span>
<span class="va">zip_files</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/10.zip</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/20.zip</span>
<span class="co">#&gt; /__w/_temp/Library/AlpsNMR/dataset-demo/30.zip</span>
<span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_read_samples.html">nmr_read_samples</a></span><span class="op">(</span>sample_names <span class="op">=</span> <span class="va">zip_files</span><span class="op">)</span>
<span class="va">dataset</span>
<span class="co">#&gt; An nmr_dataset (3 samples)</span></code></pre></div>
<p>As we have not added any metadata to this dataset, the only column we see is the <code>NMRExperiment</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/nmr_meta_get.html">nmr_meta_get</a></span><span class="op">(</span><span class="va">dataset</span>, groups <span class="op">=</span> <span class="st">"external"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 1</span>
<span class="co">#&gt;   NMRExperiment</span>
<span class="co">#&gt;   &lt;chr&gt;        </span>
<span class="co">#&gt; 1 10           </span>
<span class="co">#&gt; 2 20           </span>
<span class="co">#&gt; 3 30</span></code></pre></div>
</div>
<div id="adding-metadata" class="section level1">
<h1 class="hasAnchor">
<a href="#adding-metadata" class="anchor"></a>Adding metadata</h1>
<p>Initally our dataset only has the <code>NMRExperiment</code> column:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/nmr_meta_get.html">nmr_meta_get</a></span><span class="op">(</span><span class="va">dataset</span>, groups <span class="op">=</span> <span class="st">"external"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 1</span>
<span class="co">#&gt;   NMRExperiment</span>
<span class="co">#&gt;   &lt;chr&gt;        </span>
<span class="co">#&gt; 1 10           </span>
<span class="co">#&gt; 2 20           </span>
<span class="co">#&gt; 3 30</span></code></pre></div>
<p>The <code>exp_subj_id</code> table we loaded links the <code>NMRExperiment</code> to the <code>SubjectID</code>.</p>
<p>As we already have the <code>NMRExperiment</code> column, we can use it as the merging column (note that both columns have the same column name to match the metadata such as group class, age, BMI…):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_meta_add.html">nmr_meta_add</a></span><span class="op">(</span><span class="va">dataset</span>, metadata <span class="op">=</span> <span class="va">exp_subj_id</span>, by <span class="op">=</span> <span class="st">"NMRExperiment"</span><span class="op">)</span>
<span class="fu"><a href="../reference/nmr_meta_get.html">nmr_meta_get</a></span><span class="op">(</span><span class="va">dataset</span>, groups <span class="op">=</span> <span class="st">"external"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 3</span>
<span class="co">#&gt;   NMRExperiment SubjectID TimePoint</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;chr&gt;     &lt;chr&gt;    </span>
<span class="co">#&gt; 1 10            Ana       baseline </span>
<span class="co">#&gt; 2 20            Ana       3 months </span>
<span class="co">#&gt; 3 30            Elia      baseline</span></code></pre></div>
<p>If we have info from different files we can match them. For instance, now we have the <code>SubjectID</code> information so we can add the table that adds the <code>SubjectID</code> to the <code>Age</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_meta_add.html">nmr_meta_add</a></span><span class="op">(</span><span class="va">dataset</span>, metadata <span class="op">=</span> <span class="va">subj_id_age</span>, by <span class="op">=</span> <span class="st">"SubjectID"</span><span class="op">)</span>
<span class="fu"><a href="../reference/nmr_meta_get.html">nmr_meta_get</a></span><span class="op">(</span><span class="va">dataset</span>, groups <span class="op">=</span> <span class="st">"external"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 4</span>
<span class="co">#&gt;   NMRExperiment SubjectID TimePoint   Age</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 10            Ana       baseline     29</span>
<span class="co">#&gt; 2 20            Ana       3 months     29</span>
<span class="co">#&gt; 3 30            Elia      baseline      0</span></code></pre></div>
<p>Now we have our metadata integrated in the dataset and we can make use of it in further data analysis steps.</p>
</div>
<div id="interpolation" class="section level1">
<h1 class="hasAnchor">
<a href="#interpolation" class="anchor"></a>Interpolation</h1>
<p>1D NMR samples can be interpolated together, in order to arrange all the spectra into a matrix, with one row per sample. The main parameters we would need is the range of ppm values that we want to interpolate and the resolution.</p>
<p>We can see the ppm resolution by looking at the ppm axis of one sample:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ppm_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_ppm_resolution.html">nmr_ppm_resolution</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"The ppm resolution is: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">ppm_res</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">" ppm"</span><span class="op">)</span>
<span class="co">#&gt; The ppm resolution is: 0.00023 ppm</span></code></pre></div>
<p>We can interpolate the dataset, obtaining an <code>nmr_dataset_1D</code> object:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_interpolate_1D.html">nmr_interpolate_1D</a></span><span class="op">(</span><span class="va">dataset</span>, axis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>min <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, max <span class="op">=</span> <span class="fl">10</span>, by <span class="op">=</span> <span class="fl">2.3E-4</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This operation changes the class of the object, as now the data is on a matrix. The dataset is now of class <code>nmr_dataset_1D</code>. The <code>axis</code> element is now a numeric vector and the <code>data_1r</code> element is a matrix.</p>
</div>
<div id="plotting-samples" class="section level1">
<h1 class="hasAnchor">
<a href="#plotting-samples" class="anchor"></a>Plotting samples</h1>
<p>The <code>AlpsNMR</code> package offers the possibility to plot <code>nmr_dataset_1D</code> objects. Plotting many spectra with so many points is quite expensive so it is possible to include only some regions of the spectra or plot only some samples.</p>
<p>Use <code><a href="../reference/plot.nmr_dataset_1D.html">?plot.nmr_dataset_1D</a></code> to check the parameters, among them:</p>
<ul>
<li>
<code>NMRExperiment</code>: A character vector with the NMR experiments to plot</li>
<li>
<code>chemshift_range</code>: A ppm range to plot only a small region, or to reduce the resolution</li>
<li>
<code>interactive</code>: To make the plot interactive - <code>...</code>: Can be used to pass additional parameters such as <code>color = "SubjectID"</code> that are passed as aesthetics to ggplot.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dataset</span>, NMRExperiment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"10"</span>, <span class="st">"30"</span><span class="op">)</span>, chemshift_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.2</span>, <span class="fl">2.8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<div id="creating-interactive-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-interactive-plots" class="anchor"></a>Creating interactive plots</h2>
<p>The option <code>interactive = TRUE</code> described above has some performance limitations. As high performance workaround, you can make many plots interactive with the function <code>plot_interactive</code>.</p>
<p>This function will use WebGL technologies to create a webpage that, once opened, allows you to interact with the plot.</p>
<p>Due to technical limitations, these plots need to be opened manually and can’t be embedded in RMarkdown documents. Therefore, the function saves the plot in the directory for further exploration. Additionally, some old web browsers may not be able to display these interactive plots correctly.</p>
<pre><code>plt &lt;- plot(dataset, NMRExperiment = c("10", "30"), chemshift_range = c(2.2, 2.8))
plot_interactive(plt, "plot_region.html")</code></pre>
</div>
</div>
<div id="exclude-regions" class="section level1">
<h1 class="hasAnchor">
<a href="#exclude-regions" class="anchor"></a>Exclude regions</h1>
<p>Some regions can easily be excluded from the spectra with <code>nmr_exclude_region</code>. Note that the regions are fully removed and not zeroed, as using zeros complicates a lot the implementation<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> and has little advantages.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">regions_to_exclude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>water <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.6</span>, <span class="fl">5</span><span class="op">)</span>, methanol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.33</span>, <span class="fl">3.39</span><span class="op">)</span><span class="op">)</span>
<span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_exclude_region.html">nmr_exclude_region</a></span><span class="op">(</span><span class="va">dataset</span>, exclude <span class="op">=</span> <span class="va">regions_to_exclude</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dataset</span>, chemshift_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.2</span>, <span class="fl">5.5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
<div id="filter-samples" class="section level1">
<h1 class="hasAnchor">
<a href="#filter-samples" class="anchor"></a>Filter samples</h1>
<p>Maybe we just want to analyze a subset of the data, e.g., only a class group or a particular gender. We can filter some samples according to their metadata as follows:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples_10_20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="va">SubjectID</span> <span class="op">==</span> <span class="st">"Ana"</span><span class="op">)</span>
<span class="fu"><a href="../reference/nmr_meta_get.html">nmr_meta_get</a></span><span class="op">(</span><span class="va">samples_10_20</span>, groups <span class="op">=</span> <span class="st">"external"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 4</span>
<span class="co">#&gt;   NMRExperiment SubjectID TimePoint   Age</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 10            Ana       baseline     29</span>
<span class="co">#&gt; 2 20            Ana       3 months     29</span></code></pre></div>
</div>
<div id="robust-pca-for-outlier-detection" class="section level1">
<h1 class="hasAnchor">
<a href="#robust-pca-for-outlier-detection" class="anchor"></a>Robust PCA for outlier detection</h1>
<p>The AlpsNMR package includes robust PCA analysis for outlier detection. With such a small demo dataset, it is not practical to use, but check out the documentation of <code>nmr_pca_outliers_*</code> functions.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pca_outliers_rob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_pca_outliers_robust.html">nmr_pca_outliers_robust</a></span><span class="op">(</span><span class="va">dataset</span>, ncomp <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="../reference/nmr_pca_outliers_plot.html">nmr_pca_outliers_plot</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="va">pca_outliers_rob</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
</div>
<div id="baseline-removal" class="section level1">
<h1 class="hasAnchor">
<a href="#baseline-removal" class="anchor"></a>Baseline removal</h1>
<p>Spectra may display an unstable baseline, specially when processing blood/fecal blood/fecal samples. If so, <code>nmr_baseline_removal</code> subtract the baseline by means of Asymmetric Least Squares method.</p>
<p>See before:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dataset</span>, chemshift_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.5</span>,<span class="fl">3.8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>And after:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset</span> <span class="op">=</span> <span class="fu"><a href="../reference/nmr_baseline_removal.html">nmr_baseline_removal</a></span><span class="op">(</span><span class="va">dataset</span>, lambda <span class="op">=</span> <span class="fl">6</span>, p <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dataset</span>, chemshift_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.5</span>,<span class="fl">3.8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
</div>
<div id="peak-detection" class="section level1">
<h1 class="hasAnchor">
<a href="#peak-detection" class="anchor"></a>Peak detection</h1>
<p>The peak detection is performed on short spectra segments using a continuous wavelet transform. See <code><a href="../reference/validate_nmr_dataset_peak_table.html">?nmr_detect_peaks</a></code> for more information.</p>
<p>Our current approach relies on the use of the baseline threshold (<code>baselineThresh</code>) automatic calculated (see <code><a href="../reference/nmr_baseline_threshold.html">?nmr_baseline_threshold</a></code>) and the Signal to Noise Threshold (<code>SNR.Th</code>) to discriminate valid peaks from noise.</p>
<p>The combination of the <code>baselineThresh</code> and the <code>SNR.Th</code> optimizes the number of actual peaks from noise.</p>
<p>The advantage of the <code>SNR.Th</code> method is that it estimates the noise level on each spectra region independently, so in practice it can be used as a dynamic baseline threshold level.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">peak_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate_nmr_dataset_peak_table.html">nmr_detect_peaks</a></span><span class="op">(</span><span class="va">dataset</span>,
                               nDivRange_ppm <span class="op">=</span> <span class="fl">0.1</span>,
                               scales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span>, <span class="fl">2</span><span class="op">)</span>,
                               baselineThresh <span class="op">=</span> <span class="cn">NULL</span>, SNR.Th <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random</span>
<span class="co">#&gt; numbers without specifying argument 'seed'. There is a risk that those random</span>
<span class="co">#&gt; numbers are not statistically sound and the overall results might be invalid.</span>
<span class="co">#&gt; To fix this, specify 'seed=TRUE'. This ensures that proper, parallel-safe random</span>
<span class="co">#&gt; numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use</span>
<span class="co">#&gt; 'seed=NULL', or set option 'future.rng.onMisuse' to "ignore".</span>
<span class="co">#&gt; Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random</span>
<span class="co">#&gt; numbers without specifying argument 'seed'. There is a risk that those random</span>
<span class="co">#&gt; numbers are not statistically sound and the overall results might be invalid.</span>
<span class="co">#&gt; To fix this, specify 'seed=TRUE'. This ensures that proper, parallel-safe random</span>
<span class="co">#&gt; numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use</span>
<span class="co">#&gt; 'seed=NULL', or set option 'future.rng.onMisuse' to "ignore".</span>
<span class="co">#&gt; Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random</span>
<span class="co">#&gt; numbers without specifying argument 'seed'. There is a risk that those random</span>
<span class="co">#&gt; numbers are not statistically sound and the overall results might be invalid.</span>
<span class="co">#&gt; To fix this, specify 'seed=TRUE'. This ensures that proper, parallel-safe random</span>
<span class="co">#&gt; numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use</span>
<span class="co">#&gt; 'seed=NULL', or set option 'future.rng.onMisuse' to "ignore".</span>
<span class="va">NMRExp_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_align_find_ref.html">nmr_align_find_ref</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="va">peak_table</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Your reference is NMRExperiment "</span>, <span class="va">NMRExp_ref</span><span class="op">)</span>
<span class="co">#&gt; Your reference is NMRExperiment 20</span>
<span class="fu"><a href="../reference/validate_nmr_dataset_peak_table.html">nmr_detect_peaks_plot</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="va">peak_table</span>, NMRExperiment <span class="op">=</span> <span class="st">"20"</span>, chemshift_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.5</span>,<span class="fl">3.8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
</div>
<div id="spectra-alignment" class="section level1">
<h1 class="hasAnchor">
<a href="#spectra-alignment" class="anchor"></a>Spectra alignment</h1>
<p>To align the sample, we use the <code>nmr_align</code> function, which in turn uses a hierarchical clustering method (see <code><a href="../reference/validate_nmr_dataset_peak_table.html">?nmr_align</a></code> for further details).</p>
<p>The <code>maxShift_ppm</code> limits the maximum shift allowed for the spectra.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nmr_exp_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_align_find_ref.html">nmr_align_find_ref</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="va">peak_table</span><span class="op">)</span>
<span class="va">dataset_align</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate_nmr_dataset_peak_table.html">nmr_align</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="va">peak_table</span>, <span class="va">nmr_exp_ref</span>, maxShift_ppm <span class="op">=</span> <span class="fl">0.0015</span>, acceptLostPeak <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dataset</span>, chemshift_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.025</span>, <span class="fl">3.063</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dataset_align</span>, chemshift_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.025</span>, <span class="fl">3.063</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-20-2.png" width="672"></p>
</div>
<div id="normalization" class="section level1">
<h1 class="hasAnchor">
<a href="#normalization" class="anchor"></a>Normalization</h1>
<p>There are multiple normalization techniques available. The most strongly recommended is the <code>pqn</code> normalization, but it may not be fully reliable when the number of samples is small, as it needs a computation of the median spectra. Nevertheless, it is possible to compute it:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_normalize.html">nmr_normalize</a></span><span class="op">(</span><span class="va">dataset_align</span>, method <span class="op">=</span> <span class="st">"pqn"</span><span class="op">)</span>
<span class="co">#&gt; Warning in norm_pqn(samples[["data_1r"]]): The Probabalistic Quotient</span>
<span class="co">#&gt; Normalization requires several samples to compute the median spectra. Your</span>
<span class="co">#&gt; number of samples is low</span></code></pre></div>
<p>The <code>AlpsNMR</code> package offers the possibility to extract additional normalization information with <code><a href="../reference/nmr_normalize.html">nmr_normalize_extra_info(dataset)</a></code>, to explore the normalization factors applied to each sample:</p>
<p>The plot shows the dispersion with respect to the median of the normalization factors, and can highlight samples with abnormaly large or small normalization factors.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diagnostic</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_normalize.html">nmr_normalize_extra_info</a></span><span class="op">(</span><span class="va">dataset_norm</span><span class="op">)</span>
<span class="va">diagnostic</span><span class="op">$</span><span class="va">norm_factor</span>
<span class="co">#&gt;   NMRExperiment norm_factor norm_factor_norm</span>
<span class="co">#&gt; 1            10   520968669        0.8708718</span>
<span class="co">#&gt; 2            20   690154843        1.1536901</span>
<span class="co">#&gt; 3            30   598215122        1.0000000</span>
<span class="va">diagnostic</span><span class="op">$</span><span class="va">plot</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
</div>
<div id="peak-integration" class="section level1">
<h1 class="hasAnchor">
<a href="#peak-integration" class="anchor"></a>Peak integration</h1>
<div id="integration-based-on-peak-center-and-width" class="section level2">
<h2 class="hasAnchor">
<a href="#integration-based-on-peak-center-and-width" class="anchor"></a>1. Integration based on peak center and width</h2>
<p>If we want to integrate the whole spectra, we need ppm from the <code>peak_table</code>. See <code>Peak detection</code> section. The function <code>nmr_integrate_peak_positions</code> generates a new <code>nmr_dataset_1D</code> object containing the integrals from the <code>peak_table</code> (ppm values corresponding to detected peaks).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">peak_table_integration</span> <span class="op">=</span> <span class="fu"><a href="../reference/validate_nmr_dataset_peak_table.html">nmr_integrate_peak_positions</a></span><span class="op">(</span>
  samples <span class="op">=</span> <span class="va">dataset_norm</span>,
  peak_pos_ppm <span class="op">=</span> <span class="va">peak_table</span><span class="op">$</span><span class="va">ppm</span>,
  peak_width_ppm <span class="op">=</span> <span class="fl">0.006</span><span class="op">)</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `ppm_-0.0002` -&gt; `ppm_-0.0002...1`</span>
<span class="co">#&gt; * ppm_0.9032 -&gt; ppm_0.9032...4</span>
<span class="co">#&gt; * ppm_0.9085 -&gt; ppm_0.9085...5</span>
<span class="co">#&gt; * ppm_0.9196 -&gt; ppm_0.9196...6</span>
<span class="co">#&gt; * ppm_0.9437 -&gt; ppm_0.9437...7</span>
<span class="co">#&gt; * ...</span>

<span class="va">peak_table_integration</span> <span class="op">=</span> <span class="fu"><a href="../reference/validate_nmr_dataset_peak_table.html">get_integration_with_metadata</a></span><span class="op">(</span><span class="va">peak_table_integration</span><span class="op">)</span></code></pre></div>
<p>We can also integrate with a specific peak position and some arbitrary width:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/nmr_data.html">nmr_data</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/validate_nmr_dataset_peak_table.html">nmr_integrate_peak_positions</a></span><span class="op">(</span>samples <span class="op">=</span> <span class="va">dataset_norm</span>,
                            peak_pos_ppm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.1925</span>, <span class="fl">4.183</span>, <span class="fl">4.1775</span>, <span class="fl">4.17</span><span class="op">)</span>,
                            peak_width_ppm <span class="op">=</span> <span class="fl">0.006</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt;      ppm_4.1925   ppm_4.1830   ppm_4.1775   ppm_4.1700</span>
<span class="co">#&gt; 10 3.199480e-08 3.307910e-08 2.319829e-08 1.343858e-08</span>
<span class="co">#&gt; 20 2.543387e-08 1.775268e-08 1.808552e-08 9.949101e-09</span>
<span class="co">#&gt; 30 2.571741e-08 2.550170e-08 1.911236e-08 8.217628e-09</span></code></pre></div>
</div>
<div id="integration-based-on-peak-boundaries" class="section level2">
<h2 class="hasAnchor">
<a href="#integration-based-on-peak-boundaries" class="anchor"></a>2. Integration based on peak boundaries</h2>
<p>Imagine we only want to integrate the four peaks corresponding to the pyroglutamic acid:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pyroglutamic_acid_region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.15</span>, <span class="fl">4.20</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dataset_norm</span>, chemshift_range <span class="op">=</span> <span class="va">pyroglutamic_acid_region</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Pyroglutamic acid region"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>We define the peak regions and integrate them. Note how we can correct the baseline or not. If we correct the baseline, the limits of the integration will be connected with a straight line and that line will be used as the baseline, that will be subtracted.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pyroglutamic_acid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pyroglutamic_acid1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.19</span>, <span class="fl">4.195</span><span class="op">)</span>,
                          pyroglutamic_acid2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.18</span>, <span class="fl">4.186</span><span class="op">)</span>,
                          pyroglutamic_acid3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.175</span>, <span class="fl">4.18</span><span class="op">)</span>,
                          pyroglutamic_acid4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.165</span>, <span class="fl">4.172</span><span class="op">)</span><span class="op">)</span>
<span class="va">regions_basel_corr_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_integrate_regions.html">nmr_integrate_regions</a></span><span class="op">(</span><span class="va">dataset_norm</span>, <span class="va">pyroglutamic_acid</span>, fix_baseline <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">regions_basel_corr_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_data.html">nmr_data</a></span><span class="op">(</span><span class="va">regions_basel_corr_ds</span><span class="op">)</span>
<span class="va">regions_basel_corr_matrix</span>
<span class="co">#&gt;    pyroglutamic_acid1 pyroglutamic_acid2 pyroglutamic_acid3 pyroglutamic_acid4</span>
<span class="co">#&gt; 10       2.679967e-08       3.307910e-08       2.441353e-08       5.588898e-08</span>
<span class="co">#&gt; 20       2.152805e-08       1.775268e-08       1.201631e-08       5.132786e-08</span>
<span class="co">#&gt; 30       2.299145e-08       2.550170e-08       1.822286e-08       5.187043e-08</span>


<span class="va">regions_basel_not_corr_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_integrate_regions.html">nmr_integrate_regions</a></span><span class="op">(</span><span class="va">dataset_norm</span>, <span class="va">pyroglutamic_acid</span>, fix_baseline <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">regions_basel_not_corr_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_data.html">nmr_data</a></span><span class="op">(</span><span class="va">regions_basel_not_corr_ds</span><span class="op">)</span>
<span class="va">regions_basel_not_corr_matrix</span>
<span class="co">#&gt;    pyroglutamic_acid1 pyroglutamic_acid2 pyroglutamic_acid3 pyroglutamic_acid4</span>
<span class="co">#&gt; 10       2.784051e-07       3.337131e-07       2.691285e-07       3.776341e-07</span>
<span class="co">#&gt; 20       2.720955e-07       3.286697e-07       2.667187e-07       3.788178e-07</span>
<span class="co">#&gt; 30       2.698978e-07       3.248928e-07       2.624279e-07       3.671806e-07</span></code></pre></div>
<p>We may plot the integral values to explore variation based on the baseline subtraction.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="va">regions_basel_corr_matrix</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"NMRExperiment"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="st">"metabolite_peak"</span>, <span class="st">"area"</span>, <span class="op">-</span><span class="va">NMRExperiment</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>BaselineCorrected <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  <span class="va">regions_basel_not_corr_matrix</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"NMRExperiment"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="st">"metabolite_peak"</span>, <span class="st">"area"</span>, <span class="op">-</span><span class="va">NMRExperiment</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>BaselineCorrected <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">NMRExperiment</span>, y <span class="op">=</span> <span class="va">area</span>, color <span class="op">=</span> <span class="va">metabolite_peak</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">BaselineCorrected</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-27-1.png" width="672"></p>
</div>
</div>
<div id="identification" class="section level1">
<h1 class="hasAnchor">
<a href="#identification" class="anchor"></a>Identification</h1>
<p>After applying any feature selection or machine learning, Alps allows the identification of features of interest through <code>nmr_identify_regions_blood</code>. The function gives 3 posibilities sorted by the most probable metabolite (see <code>nmr_identify_regions_blood</code> for details).</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ppm_to_assign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.060960203</span>, <span class="fl">3.048970634</span>,<span class="fl">2.405935596</span>,<span class="fl">0.990616851</span>,<span class="fl">0.986520147</span>, <span class="fl">1.044258467</span><span class="op">)</span>
<span class="va">identification</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_identify_regions_blood.html">nmr_identify_regions_blood</a></span> <span class="op">(</span><span class="va">ppm_to_assign</span><span class="op">)</span></code></pre></div>
</div>
<div id="free-experimentation" class="section level1">
<h1 class="hasAnchor">
<a href="#free-experimentation" class="anchor"></a>Free experimentation</h1>
<div id="getting-the-spectra-and-manipulating-it-manually" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-the-spectra-and-manipulating-it-manually" class="anchor"></a>Getting the spectra and manipulating it manually</h2>
<p>Besides all those techniques, you can easily implement your own. You can extract the raw matrix and manipulate it at will. As long as you don’t permute the rows, you can always replace the raw matrix of the <code>nmr_dataset_1D</code> object through the <code>nmr_data</code> function:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_spectra_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmr_data.html">nmr_data</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>
<span class="va">full_spectra_matrix</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="co"># change it as you wish</span>
<span class="co">#&gt;        -0.5 -0.49977  -0.49954  -0.49931  -0.49908  -0.49885</span>
<span class="co">#&gt; 10 1672.044 1433.898 1072.3294 1401.1787 1634.7485 1344.6377</span>
<span class="co">#&gt; 20 1927.617 2056.491 1848.7379 1584.5820 1970.5705 2469.3993</span>
<span class="co">#&gt; 30 1337.001 1029.662  645.6248  641.0098  825.0757  799.6986</span>
<span class="fu"><a href="../reference/nmr_data.html">nmr_data</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">full_spectra_matrix</span> <span class="co"># Rewrite the matrix</span></code></pre></div>
</div>
<div id="creating-an-nmr_dataset_1d-object-from-a-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-an-nmr_dataset_1d-object-from-a-matrix" class="anchor"></a>Creating an <code>nmr_dataset_1D</code> object from a matrix</h2>
<p>You can also create an <code>nmr_dataset_1D</code> object from scratch with the <code>new_nmr_dataset_1D</code> function:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nsamp</span> <span class="op">&lt;-</span> <span class="fl">12</span>
<span class="va">npoints</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="co"># Create a random spectra matrix</span>
<span class="va">dummy_ppm_axis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0.2</span>, to <span class="op">=</span> <span class="fl">10</span>, length.out <span class="op">=</span> <span class="va">npoints</span><span class="op">)</span>
<span class="va">dummy_spectra_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">nsamp</span><span class="op">*</span><span class="va">npoints</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nsamp</span>, ncol <span class="op">=</span> <span class="va">npoints</span><span class="op">)</span>
<span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>external <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>NMRExperiment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Sample"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>,
                                       DummyClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>,
                                       stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
<span class="va">your_custom_nmr_dataset_1D</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nmr_dataset_1D.html">new_nmr_dataset_1D</a></span><span class="op">(</span>ppm_axis <span class="op">=</span> <span class="va">dummy_ppm_axis</span>,
                                                 data_1r <span class="op">=</span> <span class="va">dummy_spectra_matrix</span>,
                                                 metadata <span class="op">=</span> <span class="va">metadata</span><span class="op">)</span>
<span class="va">your_custom_nmr_dataset_1D</span>
<span class="co">#&gt; An nmr_dataset_1D (12 samples)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">your_custom_nmr_dataset_1D</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Of course those random values don't make much sense..."</span><span class="op">)</span></code></pre></div>
<p><img src="introduction-to-alpsnmr_files/figure-html/unnamed-chunk-30-1.png" width="672"></p>
</div>
</div>
<div id="final-thoughts" class="section level1">
<h1 class="hasAnchor">
<a href="#final-thoughts" class="anchor"></a>Final thoughts</h1>
<p>This vignette shows many of the features of the package, some features have room for improvement, others are not fully described, and the reader will need to browse the documentation. Hopefully it is a good starting point for using the package.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; R version 4.1.0 (2021-05-18)</span>
<span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span>
<span class="co">#&gt; Running under: Ubuntu 20.04.2 LTS</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt;  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span>
<span class="co">#&gt;  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span>
<span class="co">#&gt;  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             </span>
<span class="co">#&gt;  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span>
<span class="co">#&gt;  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span>
<span class="co">#&gt; [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt; [1] ggplot2_3.3.5  AlpsNMR_3.3.3  magrittr_2.0.1 future_1.21.0  dplyr_1.0.7   </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;   [1] colorspace_2.0-2            ellipsis_0.3.2             </span>
<span class="co">#&gt;   [3] rprojroot_2.0.2             speaq_2.6.1                </span>
<span class="co">#&gt;   [5] corpcor_1.6.9               XVector_0.32.0             </span>
<span class="co">#&gt;   [7] GenomicRanges_1.44.0        fs_1.5.0                   </span>
<span class="co">#&gt;   [9] listenv_0.8.0               furrr_0.2.3                </span>
<span class="co">#&gt;  [11] farver_2.1.0                ggrepel_0.9.1              </span>
<span class="co">#&gt;  [13] RSpectra_0.16-0             fansi_0.5.0                </span>
<span class="co">#&gt;  [15] mvtnorm_1.1-2               xml2_1.3.2                 </span>
<span class="co">#&gt;  [17] codetools_0.2-18            cachem_1.0.5               </span>
<span class="co">#&gt;  [19] impute_1.66.0               knitr_1.33                 </span>
<span class="co">#&gt;  [21] mixOmics_6.16.3             itertools_0.1-3            </span>
<span class="co">#&gt;  [23] cluster_2.1.2               missForest_1.4             </span>
<span class="co">#&gt;  [25] compiler_4.1.0              httr_1.4.2                 </span>
<span class="co">#&gt;  [27] assertthat_0.2.1            RcppZiggurat_0.1.6         </span>
<span class="co">#&gt;  [29] Matrix_1.3-4                fastmap_1.1.0              </span>
<span class="co">#&gt;  [31] cli_3.0.1                   htmltools_0.5.1.1          </span>
<span class="co">#&gt;  [33] tools_4.1.0                 igraph_1.2.6               </span>
<span class="co">#&gt;  [35] qtl_1.48-1                  gtable_0.3.0               </span>
<span class="co">#&gt;  [37] glue_1.4.2                  GenomeInfoDbData_1.2.6     </span>
<span class="co">#&gt;  [39] reshape2_1.4.4              Rcpp_1.0.7                 </span>
<span class="co">#&gt;  [41] limSolve_1.5.6              Biobase_2.52.0             </span>
<span class="co">#&gt;  [43] cellranger_1.1.0            pkgdown_1.6.1              </span>
<span class="co">#&gt;  [45] vctrs_0.3.8                 baseline_1.3-1             </span>
<span class="co">#&gt;  [47] iterators_1.0.13            xfun_0.24                  </span>
<span class="co">#&gt;  [49] stringr_1.4.0               globals_0.14.0             </span>
<span class="co">#&gt;  [51] rvest_1.0.1                 lpSolve_5.6.15             </span>
<span class="co">#&gt;  [53] lifecycle_1.0.0             zlibbioc_1.38.0            </span>
<span class="co">#&gt;  [55] MASS_7.3-54                 scales_1.1.1               </span>
<span class="co">#&gt;  [57] ragg_1.1.3                  doSNOW_1.0.19              </span>
<span class="co">#&gt;  [59] MatrixGenerics_1.4.1        parallel_4.1.0             </span>
<span class="co">#&gt;  [61] SummarizedExperiment_1.22.0 MassSpecWavelet_1.58.0     </span>
<span class="co">#&gt;  [63] SparseM_1.81                RColorBrewer_1.1-2         </span>
<span class="co">#&gt;  [65] yaml_2.2.1                  memoise_2.0.0              </span>
<span class="co">#&gt;  [67] gridExtra_2.3               stringi_1.7.3              </span>
<span class="co">#&gt;  [69] highr_0.9                   S4Vectors_0.30.0           </span>
<span class="co">#&gt;  [71] desc_1.3.0                  pcaPP_1.9-74               </span>
<span class="co">#&gt;  [73] foreach_1.5.1               randomForest_4.6-14        </span>
<span class="co">#&gt;  [75] BiocGenerics_0.38.0         BiocParallel_1.26.1        </span>
<span class="co">#&gt;  [77] GenomeInfoDb_1.28.1         rlang_0.4.11               </span>
<span class="co">#&gt;  [79] pkgconfig_2.0.3             systemfonts_1.0.2          </span>
<span class="co">#&gt;  [81] matrixStats_0.60.0          bitops_1.0-7               </span>
<span class="co">#&gt;  [83] evaluate_0.14               lattice_0.20-44            </span>
<span class="co">#&gt;  [85] purrr_0.3.4                 labeling_0.4.2             </span>
<span class="co">#&gt;  [87] Rfast_2.0.3                 tidyselect_1.1.1           </span>
<span class="co">#&gt;  [89] parallelly_1.27.0           plyr_1.8.6                 </span>
<span class="co">#&gt;  [91] R6_2.5.0                    IRanges_2.26.0             </span>
<span class="co">#&gt;  [93] snow_0.4-3                  generics_0.1.0             </span>
<span class="co">#&gt;  [95] DelayedArray_0.18.0         pillar_1.6.2               </span>
<span class="co">#&gt;  [97] withr_2.4.2                 RCurl_1.98-1.3             </span>
<span class="co">#&gt;  [99] mQTL_1.0                    tibble_3.1.3               </span>
<span class="co">#&gt; [101] crayon_1.4.1                rARPACK_0.11-0             </span>
<span class="co">#&gt; [103] utf8_1.2.2                  ellipse_0.4.2              </span>
<span class="co">#&gt; [105] rmarkdown_2.9               grid_4.1.0                 </span>
<span class="co">#&gt; [107] readxl_1.3.1                data.table_1.14.0          </span>
<span class="co">#&gt; [109] digest_0.6.27               tidyr_1.1.3                </span>
<span class="co">#&gt; [111] outliers_0.14               textshaping_0.3.5          </span>
<span class="co">#&gt; [113] signal_0.7-7                stats4_4.1.0               </span>
<span class="co">#&gt; [115] munsell_0.5.0               quadprog_1.5-8</span></code></pre></div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>e.g. it can inadvertedly distort the PQN normalization results<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ivan Montoliu Roura, Sergio Oller Moreno, Francisco Madrid Gambin, Luis Fernandez, Héctor Gracia Cabrera, Santiago Marco Colás.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
